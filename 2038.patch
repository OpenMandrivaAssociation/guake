From 8216591335f10887b723dbd926a9c089561d3115 Mon Sep 17 00:00:00 2001
From: Gaetan Semet <gaetan@xeberon.net>
Date: Sun, 6 Feb 2022 12:54:40 +0100
Subject: [PATCH 1/2] build: do not generate req in github build

Signed-off-by: Gaetan Semet <gaetan@xeberon.net>
---
 Makefile | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/Makefile b/Makefile
index 17c6efd3..6439a105 100644
--- a/Makefile
+++ b/Makefile
@@ -45,7 +45,7 @@ all: clean dev style checks dists test docs
 
 dev: clean-ln-venv ensure-pip pipenv-install-dev requirements ln-venv setup-githook \
 	 prepare-install install-dev-locale
-dev-actions: ensure-pip-system pipenv-install-dev requirements prepare-install
+dev-actions: ensure-pip-system pipenv-install-dev prepare-install
 
 ensure-pip:
 	./scripts/bootstrap-dev-pip.sh

From edd720251d47353636120f15151341d8094bb961 Mon Sep 17 00:00:00 2001
From: Gaetan Semet <gaetan@xeberon.net>
Date: Sun, 6 Feb 2022 17:38:25 +0100
Subject: [PATCH 2/2] ci: force version of package from the tag

Signed-off-by: Gaetan Semet <gaetan@xeberon.net>
---
 .github/workflows/release.yml | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/.github/workflows/release.yml b/.github/workflows/release.yml
index 824561a3..71bf66df 100644
--- a/.github/workflows/release.yml
+++ b/.github/workflows/release.yml
@@ -44,8 +44,14 @@ jobs:
 
           export DISPLAY=:99.0
 
-      - name: Test with pytest
+      - name: Set env
+        if: startsWith(github.ref, 'refs/tags')
+        run: echo "SETUPTOOLS_SCM_PRETEND_VERSION_FOR_GUAKE=$(echo $GITHUB_REF_NAME)" >> $GITHUB_ENV
+
+      - name: Build
+        if: startsWith(github.ref, 'refs/tags')
         run: |
+          echo "SETUPTOOLS_SCM_PRETEND_VERSION_FOR_GUAKE=$SETUPTOOLS_SCM_PRETEND_VERSION_FOR_GUAKE"
           set -e
           mkdir test-rtd
           virtualenv test-rtd
@@ -62,6 +68,8 @@ jobs:
           make generate-paths
 
       - name: Publish distribution ðŸ“¦ to Test PyPI
+        env:
+          SETUPTOOLS_SCM_PRETEND_VERSION_FOR_GUAKE: ${{ $(echo $GITHUB_REF_NAME) }}
         uses: pypa/gh-action-pypi-publish@master
         with:
           verify_metadata: false
@@ -69,6 +77,8 @@ jobs:
           repository_url: https://test.pypi.org/legacy/
 
       - name: Publish distribution ðŸ“¦ to PyPI
+        env:
+          SETUPTOOLS_SCM_PRETEND_VERSION_FOR_GUAKE: ${{ $(echo $GITHUB_REF_NAME) }}
         if: startsWith(github.ref, 'refs/tags')
         uses: pypa/gh-action-pypi-publish@master
         with:
